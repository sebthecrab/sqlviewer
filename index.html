<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQLite Browser ‚Äì v04 (Duplikat-Hervorhebung standard)</title>
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root { --sidebar-w: 320px; }
    body { overflow: hidden; }
    .app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; grid-template-rows: auto 1fr; height: 100vh; }
    header { grid-column: 1 / -1; }
    #sidebar { overflow: auto; border-right: 1px solid #e5e5e5; }
    #main { overflow: auto; }
    .table-wrap { overflow: auto; max-height: 50vh; border: 1px solid #eee; border-radius: .5rem; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    td[contenteditable="true"] { outline: 2px dashed transparent; }
    td[contenteditable="true"].dirty { background: #fff9e6; outline-color: #ffe08a; }
    .status-dot { width: .6rem; height: .6rem; border-radius: 50%; display: inline-block; margin-right: .4rem; }
    .status-ok { background: #22c55e; }
    .status-busy { background: #f59e0b; }
    .status-none { background: #9ca3af; }
    .small-muted { font-size: .9rem; color: #6b7280; }
    .sticky-top-lite { position: sticky; top: 0; z-index: 5; background: #fff; }
    .paginate button { min-width: 2.5rem; }
    .footer-shadow { box-shadow: 0 -6px 12px rgba(0,0,0,.04); }
    .filters .form-select, .filters .form-control { min-width: 10rem; }
    .filter-pill { gap: .4rem; }
    .filter-pill code { background: rgba(0,0,0,.04); padding: 0 .35rem; border-radius: .25rem; }
    .th-highlight { position: relative; }
    .th-highlight::after {
      content: "üéØ";
      position: absolute;
      right: 1.6rem; /* Platz f√ºr Sort-Icon */
      top: 50%;
      transform: translateY(-50%);
      font-size: .9rem;
      opacity: .6;
      pointer-events: none;
    }
    /* Sort-Indikator */
    .th-sort { position: relative; cursor: pointer; user-select: none; }
    .th-sort .sort-ind {
      position: absolute;
      right: .4rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: .85rem;
      opacity: .7;
      pointer-events: none;
    }
    .th-sort .sort-idx {
      position: absolute;
      right: 1.25rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: .7rem;
      background: #f1f5f9;
      color: #475569;
      border-radius: .3rem;
      padding: 0 .25rem;
      pointer-events: none;
    }
    td.hl { border-radius: .25rem; }
    @media (max-width: 992px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
      #sidebar { grid-row: 2; border-right: none; border-bottom: 1px solid #e5e5e5; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="p-3 border-bottom bg-light">
      <div class="container-fluid d-flex align-items-center gap-3">
        <h1 class="h5 mb-0">SQLite Browser ‚Äì v04</h1>
        <span id="status" class="small-muted ms-auto">
          <span class="status-dot status-none" id="statusDot"></span><span id="statusText">Keine Datei geladen</span>
        </span>
      </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="p-3">
      <div class="d-flex flex-column gap-3">
        <div class="card">
          <div class="card-body">
            <label for="fileInput" class="form-label fw-semibold">Datenbank-Datei √∂ffnen</label>
            <input class="form-control" type="file" id="fileInput" accept=".sqlite,.db,.sqlite3,.sqlite2,.sqlite,.db3,.db2,application/octet-stream" />
            <div class="d-flex gap-2 mt-3">
              <button id="btnExport" class="btn btn-outline-primary btn-sm" disabled>Ge√§nderte DB herunterladen</button>
              <button id="btnNewDB" class="btn btn-outline-secondary btn-sm">Neue leere DB</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h2 class="h6 mb-0">Tabellen</h2>
              <button id="btnRefreshTables" class="btn btn-light btn-sm">Aktualisieren</button>
            </div>
            <hr />
            <div id="tablesList" class="list-group small"></div>
            <div id="noTablesHint" class="text-muted small mt-2 d-none">Keine Tabellen gefunden.</div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h2 class="h6">Schnellaktionen</h2>
            <div class="d-grid gap-2">
              <button id="btnCreateTable" class="btn btn-outline-success btn-sm">Tabelle erstellen</button>
              <button id="btnDropTable" class="btn btn-outline-danger btn-sm">Tabelle l√∂schen</button>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main id="main" class="p-3">
      <div class="container-fluid d-flex flex-column gap-3">
        <!-- Query Editor -->
        <section class="card">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h2 class="h6 mb-0">SQL-Editor</h2>
              <div class="d-flex gap-2">
                <button id="btnRun" class="btn btn-primary btn-sm" disabled>Abfrage ausf√ºhren</button>
                <!--<button id="btnExplain" class="btn btn-outline-secondary btn-sm" disabled>EXPLAIN</button>-->
              </div>
            </div>
            <textarea id="sqlInput" class="form-control code mt-3" rows="5" placeholder="Beispiel: SELECT name FROM sqlite_master WHERE type='table';" disabled></textarea>
            <div class="small text-muted mt-2">Tipp: W√§hle links eine Tabelle aus, um automatisch ein SELECT zu erhalten.</div>
          </div>
        </section>

        <!-- Filters + Results -->
        <section class="card">
          <div class="card-body">
            <!-- Filter-Builder + Sort Controls -->
            <div class="sticky-top-lite pt-2 pb-2">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2 filters">
                  <select id="filterColumn" class="form-select form-select-sm" disabled>
                    <option value="">Spalte w√§hlen‚Ä¶</option>
                  </select>
                  <select id="filterOperator" class="form-select form-select-sm" disabled>
                    <option value="=">=</option>
                    <option value="!=">‚â†</option>
                    <option value="contains">enth√§lt</option>
                    <option value="starts">beginnt mit</option>
                    <option value="ends">endet mit</option>
                    <option value=">">&gt;</option>
                    <option value=">=">&gt;=</option>
                    <option value="<">&lt;</option>
                    <option value="<=">&lt;=</option>
                    <option value="isnull">ist NULL/leer</option>
                    <option value="notnull">ist NICHT NULL/leer</option>
                  </select>
                  <input id="filterValue" class="form-control form-control-sm" placeholder="Wert‚Ä¶" disabled />
                  <button id="btnAddFilter" class="btn btn-outline-primary btn-sm" disabled>Filter hinzuf√ºgen</button>
                  <button id="btnClearFilters" class="btn btn-outline-secondary btn-sm" disabled>Alle Filter l√∂schen</button>
                </div>

                <div class="d-flex align-items-center gap-2 flex-wrap">
                  <div class="d-flex align-items-center gap-2">
                    <label class="small text-muted">Hervorheben nach</label>
                    <select id="highlightColumn" class="form-select form-select-sm" disabled style="min-width: 12rem;">
                      <option value="">‚Äì aus ‚Äì</option>
                    </select>
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="highlightOnlyDuplicates" disabled>
                      <label class="form-check-label small" for="highlightOnlyDuplicates">nur Duplikate</label>
                    </div>
                  </div>

                  <div class="d-flex align-items-center gap-2 ms-lg-3">
                    <span class="small text-muted">Sortierung</span>
                    <button id="btnClearSort" class="btn btn-outline-secondary btn-sm" disabled>Sortierung zur√ºcksetzen</button>
                  </div>

                  <label class="small text-muted ms-lg-2">Limit</label>
                  <input type="number" id="pageSize" class="form-control form-control-sm" style="width: 6rem;" value="100" min="10" max="10000" />
                  <div class="paginate btn-group">
                    <button id="prevPage" class="btn btn-outline-secondary btn-sm" disabled>&laquo;</button>
                    <button id="nextPage" class="btn btn-outline-secondary btn-sm" disabled>&raquo;</button>
                  </div>
                  <button id="btnSaveChanges" class="btn btn-success btn-sm" disabled>√Ñnderungen speichern</button>
                </div>
              </div>

              <!-- Aktive Filter Pills -->
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mt-2">
                <div id="activeFilters" class="d-flex flex-wrap gap-2"></div>
                <div class="small text-muted">
                  <span id="resultInfo" class="badge text-bg-light">0 Zeilen</span>
                  <span class="ms-2">Klick auf Spaltenkopf sortiert (Shift = Mehrspaltig). Rechtsklick auf eine Zelle ‚Üí ‚ÄûNach diesem Wert filtern‚Äú.</span>
                </div>
              </div>
            </div>

            <!-- Table -->
            <div id="results" class="table-wrap mt-3">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div id="message" class="mt-3 small"></div>
          </div>
        </section>

        <!-- Footer -->
        <footer class="footer-shadow p-3 rounded bg-light">
          <div class="d-flex flex-column flex-lg-row gap-2 align-items-start align-items-lg-center justify-content-between">
            <div class="small-muted">
              √Ñnderungen erfolgen im Speicher der geladenen DB. Mit <em>‚ÄûGe√§nderte DB herunterladen‚Äú</em> speicherst du die Datei lokal ab.
            </div>
          </div>
        </footer>
      </div>
    </main>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- sql.js (WASM) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    // --- State ---
    let SQL = null;
    let db = null;
    let currentTable = null;
    let currentRows = [];
    let currentColumns = [];
    let filteredRows = [];
    let page = 0;

    // Filter / Highlight / Sort State
    const filters = []; // {col, op, val}
    let highlightCol = '';
    let highlightOnlyDup = true; // <<< Standard: nur Duplikate hervorheben
    // sortState: Array von { idx (Spaltenindex), dir: 'asc'|'desc' }
    let sortState = [];

    // UI helpers
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const statusDot = $('#statusDot');
    const statusText = $('#statusText');
    const setStatus = (text, mode = 'none') => {
      statusText.textContent = text;
      statusDot.className = 'status-dot ' + (mode === 'ok' ? 'status-ok' : mode === 'busy' ? 'status-busy' : 'status-none');
    };
    const message = (html, type='secondary') => {
      $('#message').innerHTML = `<div class="alert alert-${type} mb-0">${html}</div>`;
    };
    const clearResults = () => {
      $('#thead').innerHTML = '';
      $('#tbody').innerHTML = '';
      $('#resultInfo').textContent = '0 Zeilen';
    };

    // Initialize sql.js
    (async function init() {
      setStatus('Lade SQL-Engine ‚Ä¶', 'busy');
      SQL = await initSqlJs({
        locateFile: file => 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/' + file
      });
      setStatus('Bereit. Keine Datei geladen', 'none');
      $('#btnNewDB').disabled = false;
      // Standard: Toggle "nur Duplikate" von Anfang an aktiv anzeigen (auch vor DB-Load deaktiviert)
      const dupToggle = $('#highlightOnlyDuplicates');
      if (dupToggle) dupToggle.checked = true;
    })();

    // File open
    $('#fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      setStatus('Lade Datenbank ‚Ä¶', 'busy');
      const buf = new Uint8Array(await file.arrayBuffer());
      try { db?.close?.(); } catch {}
      db = new SQL.Database(buf);
      onDbLoaded(file.name);
    });

    // New DB
    $('#btnNewDB').addEventListener('click', () => {
      try { db?.close?.(); } catch {}
      db = new SQL.Database(); // empty
      onDbLoaded('NeueDatenbank (im Speicher)');
    });

    function onDbLoaded(name) {
      setStatus('Geladen: ' + name, 'ok');
      ['btnExport','btnRun','btnExplain','sqlInput','btnAddFilter','btnClearFilters','filterColumn','filterOperator','filterValue','highlightColumn','highlightOnlyDuplicates','btnClearSort'].forEach(id => {
        if ($(id.startsWith('#')? id : '#'+id)) $(id.startsWith('#')? id : '#'+id).disabled = false;
      });
      // Standard aktiv: nur Duplikate
      $('#highlightOnlyDuplicates').checked = true;
      highlightOnlyDup = true;

      $('#btnSaveChanges').disabled = true;
      page = 0;
      currentTable = null;
      filters.length = 0;
      highlightCol = '';
      sortState = [];
      renderFiltersUI();
      refreshTables();
      clearResults();
      message(`<strong>Datenbank geladen.</strong> W√§hle links eine Tabelle oder f√ºhre eine Abfrage aus.`, 'success');
    }

    // Export DB
    $('#btnExport').addEventListener('click', () => {
      if (!db) return;
      const bin = db.export();
      const blob = new Blob([bin], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dt = new Date().toISOString().replace(/[:.]/g, '-');
      a.href = url;
      a.download = `database_${dt}.sqlite`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Load table list
    $('#btnRefreshTables').addEventListener('click', refreshTables);
    function refreshTables() {
      if (!db) return;
      const tables = execRaw(`SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name;`);
      const list = $('#tablesList');
      list.innerHTML = '';
      if (!tables?.[0]?.values?.length) {
        $('#noTablesHint').classList.remove('d-none');
      } else {
        $('#noTablesHint').classList.add('d-none');
        tables[0].values.forEach(([name]) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          btn.textContent = name;
          btn.addEventListener('click', () => openTable(name));
          list.appendChild(btn);
        });
      }
    }

    // Quick actions
    $('#btnCreateTable').addEventListener('click', async () => {
      if (!db) return;
      const name = prompt('Name der neuen Tabelle (z. B. people):');
      if (!name) return;
      const cols = prompt('Spalten-Definition (SQL), z. B. id INTEGER PRIMARY KEY, name TEXT, age INTEGER:');
      if (cols === null) return;
      try {
        db.run(`CREATE TABLE "${name}" (${cols});`);
        refreshTables();
        message(`Tabelle <strong>${escapeHtml(name)}</strong> erstellt.`, 'success');
      } catch (e) {
        message(`Fehler beim Erstellen: <code class="code">${escapeHtml(e.message)}</code>`, 'danger');
      }
    });

    $('#btnDropTable').addEventListener('click', () => {
      if (!db) return;
      const name = prompt('Welche Tabelle l√∂schen? (exakter Name)');
      if (!name) return;
      if (!confirm(`Tabelle "${name}" wirklich l√∂schen?`)) return;
      try {
        db.run(`DROP TABLE "${name}";`);
        refreshTables();
        clearResults();
        message(`Tabelle <strong>${escapeHtml(name)}</strong> gel√∂scht.`, 'warning');
      } catch (e) {
        message(`Fehler beim L√∂schen: <code class="code">${escapeHtml(e.message)}</code>`, 'danger');
      }
    });

    // Open table (with pagination)
    async function openTable(name) {
      if (!db) return;
      currentTable = name;
      page = 0;
      filters.length = 0;
      highlightCol = '';
      sortState = [];
      // Standard aktiv: nur Duplikate
      highlightOnlyDup = true;
      $('#highlightColumn').value = '';
      $('#highlightOnlyDuplicates').checked = true;

      loadPage();
      $('#sqlInput').value = `SELECT * FROM "${name}" LIMIT 100;`;
      message(`Tabelle <strong>${escapeHtml(name)}</strong> ge√∂ffnet.`, 'info');
    }

    function loadPage() {
      const size = Math.max(10, Math.min(10000, parseInt($('#pageSize').value || '100', 10)));
      const offset = page * size;
      try {
        const res = execRaw(`SELECT rowid AS __rowid__, * FROM "${currentTable}" LIMIT ${size} OFFSET ${offset};`);
        const countRes = execRaw(`SELECT COUNT(*) AS cnt FROM "${currentTable}";`);
        const total = countRes?.[0]?.values?.[0]?.[0] ?? 0;

        renderResult(res);
        $('#resultInfo').textContent = `${filteredRows.length} Zeilen (Seite ${page + 1}, gesamt ${total}, gefiltert ${filteredRows.length})`;
        $('#prevPage').disabled = page <= 0;
        $('#nextPage').disabled = (offset + size) >= total;
        $('#btnSaveChanges').disabled = false;
        $('#btnClearSort').disabled = false;
      } catch (e) {
        const res = execRaw(`SELECT * FROM "${currentTable}" LIMIT ${size} OFFSET ${offset};`);
        renderResult(res, /*editable=*/false);
        $('#resultInfo').textContent = `${filteredRows.length} Zeilen (Seite ${page + 1})`;
        $('#prevPage').disabled = page <= 0;
        $('#nextPage').disabled = (res?.[0]?.values?.length || 0) < size;
        $('#btnSaveChanges').disabled = true;
        $('#btnClearSort').disabled = false;
        message(`Hinweis: Tabelle hat evtl. <em>WITHOUT ROWID</em> oder ist eine View ‚Äì Inline-Bearbeitung deaktiviert.`, 'warning');
      }
    }

    $('#prevPage').addEventListener('click', () => { if (page > 0) { page--; loadPage(); } });
    $('#nextPage').addEventListener('click', () => { page++; loadPage(); });

    // Run SQL from editor
    $('#btnRun').addEventListener('click', () => {
      if (!db) return;
      const sql = $('#sqlInput').value.trim();
      if (!sql) return;
      try {
        const out = execRaw(sql);
        if (!out.length) {
          clearResults();
          message('Abfrage ausgef√ºhrt (kein Ergebnis-Resultset).', 'success');
          refreshTables(); // schema may have changed
        } else {
          renderResult(out, /*editable=*/false);
          $('#resultInfo').textContent = `${filteredRows.length} Zeilen (custom query, gefiltert ${filteredRows.length})`;
          $('#btnSaveChanges').disabled = true;
          $('#btnClearSort').disabled = false;
          message('Abfrage erfolgreich.', 'success');
        }
      } catch (e) {
        message(`SQL-Fehler: <code class="code">${escapeHtml(e.message)}</code>`, 'danger');
      }
    });

    // Explain
    $('#btnExplain').addEventListener('click', () => {
      if (!db) return;
      const sql = $('#sqlInput').value.trim();
      if (!sql) return;
      try {
        const out = execRaw('EXPLAIN ' + sql);
        renderResult(out, /*editable=*/false);
        $('#resultInfo').textContent = `${filteredRows.length} Zeilen (EXPLAIN)`;
        $('#btnSaveChanges').disabled = true;
        message('EXPLAIN ausgef√ºhrt.', 'info');
      } catch (e) {
        message(`EXPLAIN-Fehler: <code class="code">${escapeHtml(e.message)}</code>`, 'danger');
      }
    });

    // Save changes (inline edits -> UPDATE ... WHERE rowid = ?)
    $('#btnSaveChanges').addEventListener('click', () => {
      if (!db || !currentTable) return;
      const dirtyCells = $$('#tbody td[contenteditable="true"].dirty');
      if (!dirtyCells.length) {
        message('Keine √Ñnderungen vorhanden.', 'secondary');
        return;
      }
      const changesByRow = new Map();
      for (const td of dirtyCells) {
        const col = td.dataset.col;
        const val = td.textContent === 'NULL' ? null : td.textContent;
        const rowid = td.dataset.rowid;
        if (!changesByRow.has(rowid)) changesByRow.set(rowid, new Map());
        changesByRow.get(rowid).set(col, val);
      }
      try {
        db.run('BEGIN;');
        for (const [rowid, changes] of changesByRow.entries()) {
          const sets = [];
          const params = [];
          for (const [col, val] of changes.entries()) {
            sets.push(`"${col}" = ?`);
            params.push(val);
          }
          params.push(rowid);
          const sql = `UPDATE "${currentTable}" SET ${sets.join(', ')} WHERE rowid = ?;`;
          const stmt = db.prepare(sql);
          stmt.bind(params);
          stmt.step();
          stmt.free();
        }
        db.run('COMMIT;');
        dirtyCells.forEach(td => { td.classList.remove('dirty'); td.dataset.original = td.textContent; });
        message(`√Ñnderungen gespeichert: ${changesByRow.size} Zeile(n) aktualisiert.`, 'success');
      } catch (e) {
        try { db.run('ROLLBACK;'); } catch {}
        message(`Fehler beim Speichern: <code class="code">${escapeHtml(e.message)}</code>`, 'danger');
      }
    });

    // Sortierung zur√ºcksetzen
    $('#btnClearSort').addEventListener('click', () => {
      sortState = [];
      if (currentColumns.length) {
        renderResult([{columns: currentColumns, values: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
      }
    });

    // Render resultset with filters, sorting & highlights
    function renderResult(result, editableDefault = true) {
      clearResults();
      if (!result || !result.length) { filteredRows = []; return; }
      const { columns, values } = result[0];
      currentColumns = columns;
      currentRows = values;

      // Build selects for filters & highlight
      fillColumnSelects();

      // Apply filters
      filteredRows = applyFilters(currentRows, currentColumns);

      // Apply sorting
      const toRender = applySorting(filteredRows, currentColumns);

      // Build header
      const thead = $('#thead');
      const trh = document.createElement('tr');
      columns.forEach((c, colIdx) => {
        const th = document.createElement('th');
        th.textContent = c;
        th.classList.add('th-sort');
        th.title = 'Klicken zum Sortieren ‚Ä¢ Shift = Mehrspaltig';
        // Sort-Indikator + Index-Badge
        const ind = document.createElement('span');
        ind.className = 'sort-ind';
        const idxBadge = document.createElement('span');
        idxBadge.className = 'sort-idx';
        const sIdx = sortState.findIndex(s => s.idx === colIdx);
        if (sIdx >= 0) {
          const dir = sortState[sIdx].dir;
          ind.textContent = dir === 'asc' ? '‚ñ≤' : '‚ñº';
          idxBadge.textContent = (sIdx + 1).toString();
          th.appendChild(idxBadge);
        } else {
          ind.textContent = '‚Äî';
          ind.style.opacity = '.35';
        }
        th.appendChild(ind);

        // Mark highlighted column
        if (highlightCol && c === highlightCol) th.classList.add('th-highlight');

        // Header click: cycle sort
        th.addEventListener('click', (ev) => {
          const withShift = ev.shiftKey;
          cycleSort(colIdx, withShift);
          renderResult([{columns: currentColumns, values: currentRows}], editableDefault);
        });

        // Doppelklick setzt Highlight-Spalte schnell
        th.addEventListener('dblclick', () => {
          highlightCol = c === '__rowid__' ? '' : c;
          renderResult([{columns: currentColumns, values: currentRows}], editableDefault);
        });

        trh.appendChild(th);
      });
      thead.appendChild(trh);

      // Build body with highlighting
      const tbody = $('#tbody');
      const rowidIdx = columns.indexOf('__rowid__');

      // Prepare highlight color map for selected column
      const hlIndex = highlightCol ? columns.indexOf(highlightCol) : -1;
      const colorMap = new Map();
      if (hlIndex >= 0) {
        const freq = new Map();
        toRender.forEach(row => {
          const v = normalizeCell(row[hlIndex]);
          freq.set(v, (freq.get(v) || 0) + 1);
        });
        toRender.forEach(row => {
          const v = normalizeCell(row[hlIndex]);
          if (highlightOnlyDup && (freq.get(v) || 0) < 2) return; // nur Duplikate bekommen Farben
          if (!colorMap.has(v)) colorMap.set(v, colorForValue(v));
        });
      }

      // Render body rows
      toRender.forEach(row => {
        const tr = document.createElement('tr');
        const rowid = rowidIdx >= 0 ? row[rowidIdx] : null;
        row.forEach((cell, idx) => {
          const td = document.createElement('td');
          const display = cell === null ? 'NULL' : String(cell);
          td.textContent = display;
          td.dataset.col = columns[idx];

          // Context menu: filter by this value
          td.addEventListener('contextmenu', (ev) => {
            ev.preventDefault();
            const col = columns[idx];
            if (col === '__rowid__') return;
            addFilter(col, 'equals-smart', display);
          });

          // Editable?
          if (rowid !== null && columns[idx] !== '__rowid__' && editableDefault) {
            td.setAttribute('contenteditable', 'true');
            td.dataset.rowid = rowid;
            td.dataset.original = display;
            td.addEventListener('input', () => {
              if (td.textContent !== td.dataset.original) td.classList.add('dirty');
              else td.classList.remove('dirty');
            });
          } else {
            td.setAttribute('contenteditable', 'false');
          }

          // Apply highlight color (nur Duplikate, wenn aktiviert)
          if (hlIndex >= 0 && idx === hlIndex) {
            const key = normalizeCell(cell);
            const colBg = colorMap.get(key);
            if (colBg) {
              td.classList.add('hl');
              td.style.background = colBg;
            } else {
              td.style.background = '';
            }
          } else {
            td.style.background = '';
          }

          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      // Info
      $('#resultInfo').textContent = `${toRender.length} Zeilen (gefiltert${sortState.length ? ', sortiert' : ''}${highlightCol ? (highlightOnlyDup ? ', Duplikate hervorgehoben' : ', Hervorhebung aktiv') : ''})`;
    }

    function fillColumnSelects() {
      const selects = [$('#filterColumn'), $('#highlightColumn')];
      selects.forEach(sel => {
        const prev = sel.value;
        sel.innerHTML = '';
        const opt0 = document.createElement('option');
        opt0.value = '';
        opt0.textContent = sel.id === 'highlightColumn' ? '‚Äì aus ‚Äì' : 'Spalte w√§hlen‚Ä¶';
        sel.appendChild(opt0);
        currentColumns.forEach(c => {
          const o = document.createElement('option');
          o.value = c;
          o.textContent = c;
          sel.appendChild(o);
        });
        if (prev && currentColumns.includes(prev)) sel.value = prev;
      });
    }

    // Filters UI
    $('#btnAddFilter').addEventListener('click', () => {
      const col = $('#filterColumn').value;
      const op = $('#filterOperator').value;
      const val = $('#filterValue').value;
      if (!col) { message('Bitte Spalte w√§hlen.', 'warning'); return; }
      if (!['isnull','notnull'].includes(op) && !val) { message('Bitte Filterwert eingeben.', 'warning'); return; }
      addFilter(col, op, val);
    });

    $('#btnClearFilters').addEventListener('click', () => {
      filters.length = 0;
      renderFiltersUI();
      if (currentColumns.length) {
        renderResult([{columns: currentColumns, values: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
      }
    });

    $('#highlightColumn').addEventListener('change', () => {
      highlightCol = $('#highlightColumn').value;
      if (currentColumns.length) {
        renderResult([{columns: currentColumns, values: filteredRows.length? filteredRows: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
      }
    });
    $('#highlightOnlyDuplicates').addEventListener('change', () => {
      highlightOnlyDup = $('#highlightOnlyDuplicates').checked;
      if (currentColumns.length) {
        renderResult([{columns: currentColumns, values: filteredRows.length? filteredRows: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
      }
    });

    function addFilter(col, op, val) {
      if (op === 'equals-smart') op = smartEqualsOp(val);
      filters.push({ col, op, val });
      renderFiltersUI();
      if (currentColumns.length) {
        renderResult([{columns: currentColumns, values: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
      }
    }

    function renderFiltersUI() {
      const wrap = $('#activeFilters');
      wrap.innerHTML = '';
      if (!filters.length) {
        const span = document.createElement('span');
        span.className = 'text-muted small';
        span.textContent = 'Keine aktiven Filter.';
        wrap.appendChild(span);
        return;
      }
      filters.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'badge text-bg-light d-inline-flex align-items-center filter-pill';
        const opLabel = opToLabel(f.op);
        const code = document.createElement('span');
        code.innerHTML = `<code>${escapeHtml(f.col)}</code> ${escapeHtml(opLabel)} ${['isnull','notnull'].includes(f.op) ? '' : '<code>'+escapeHtml(f.val)+'</code>'}`;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-secondary';
        btn.textContent = '√ó';
        btn.title = 'Filter entfernen';
        btn.addEventListener('click', () => {
          filters.splice(idx, 1);
          renderFiltersUI();
          renderResult([{columns: currentColumns, values: currentRows}], $('#tbody td[contenteditable="true"]').length>0);
        });
        div.appendChild(code);
        div.appendChild(btn);
        wrap.appendChild(div);
      });
    }

    function opToLabel(op) {
      switch (op) {
        case '=': return '=';
        case '!=': return '‚â†';
        case 'contains': return 'enth√§lt';
        case 'starts': return 'beginnt mit';
        case 'ends': return 'endet mit';
        case '>': case '>=': case '<': case '<=': return op;
        case 'isnull': return 'ist NULL/leer';
        case 'notnull': return 'ist NICHT NULL/leer';
        default: return op;
      }
    }

    function applyFilters(rows, columns) {
      if (!filters.length) return rows.slice();
      const idxMap = new Map(columns.map((c, i) => [c, i]));
      return rows.filter(row => {
        return filters.every(f => {
          const i = idxMap.get(f.col);
          const raw = i !== undefined ? row[i] : undefined;
          return evalFilter(raw, f.op, f.val);
        });
      });
    }

    function evalFilter(raw, op, val) {
      const str = raw === null || raw === undefined ? '' : String(raw);
      const isEmpty = str === '' || str.toUpperCase() === 'NULL';
      const aNum = parseFloat(str);
      const bNum = parseFloat(val);
      const aIsNum = !isNaN(aNum) && String(aNum) === str.trim();
      const bIsNum = !isNaN(bNum) && String(bNum) === String(val).trim();

      const a = aIsNum ? aNum : str.toLowerCase();
      const b = bIsNum ? bNum : String(val).toLowerCase();

      switch (op) {
        case '=': return aIsNum && bIsNum ? a === b : str.toLowerCase() === String(val).toLowerCase();
        case '!=': return aIsNum && bIsNum ? a !== b : str.toLowerCase() !== String(val).toLowerCase();
        case 'contains': return String(str).toLowerCase().includes(String(val).toLowerCase());
        case 'starts': return String(str).toLowerCase().startsWith(String(val).toLowerCase());
        case 'ends': return String(str).toLowerCase().endsWith(String(val).toLowerCase());
        case '>': return aIsNum && bIsNum ? a > b : String(str).toLowerCase() > String(val).toLowerCase();
        case '>=': return aIsNum && bIsNum ? a >= b : String(str).toLowerCase() >= String(val).toLowerCase();
        case '<': return aIsNum && bIsNum ? a < b : String(str).toLowerCase() < String(val).toLowerCase();
        case '<=': return aIsNum && bIsNum ? a <= b : String(str).toLowerCase() <= String(val).toLowerCase();
        case 'isnull': return raw === null || isEmpty;
        case 'notnull': return raw !== null && !isEmpty;
        default: return true;
      }
    }

    function smartEqualsOp(val) { return '='; }

    // --- Sorting ---
    function cycleSort(colIdx, multi) {
      const i = sortState.findIndex(s => s.idx === colIdx);
      if (i === -1) {
        if (!multi) sortState = [];
        sortState.push({ idx: colIdx, dir: 'asc' });
      } else {
        const dir = sortState[i].dir;
        if (dir === 'asc') {
          sortState[i].dir = 'desc';
        } else {
          sortState.splice(i, 1);
          if (!multi && sortState.length === 0) { /* leer lassen */ }
        }
        if (!multi) {
          if (i !== -1) {
            const entry = sortState.find(s => s.idx === colIdx);
            sortState = entry ? [entry] : [];
          }
        }
      }
    }

    function applySorting(rows, columns) {
      if (!sortState.length) return rows.slice();
      const rs = rows.slice();
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
      rs.sort((a, b) => {
        for (const s of sortState) {
          const idx = s.idx;
          const dir = s.dir === 'asc' ? 1 : -1;
          const va = a[idx];
          const vb = b[idx];

          const aNull = va === null || va === undefined || String(va) === '' || String(va).toUpperCase() === 'NULL';
          const bNull = vb === null || vb === undefined || String(vb) === '' || String(vb).toUpperCase() === 'NULL';
          if (aNull && bNull) continue;
          if (aNull && !bNull) return 1;
          if (!aNull && bNull) return -1;

          const aNum = parseFloat(String(va));
          const bNum = parseFloat(String(vb));
          const aIsNum = !isNaN(aNum) && String(aNum) === String(va).trim();
          const bIsNum = !isNaN(bNum) && String(bNum) === String(vb).trim();

          let cmp = 0;
          if (aIsNum && bIsNum) {
            cmp = (aNum < bNum) ? -1 : (aNum > bNum ? 1 : 0);
          } else {
            cmp = collator.compare(String(va), String(vb));
          }
          if (cmp !== 0) return cmp * dir;
        }
        return 0;
      });
      return rs;
    }

    // Highlight helpers
    function normalizeCell(v) {
      if (v === null || v === undefined) return 'NULL';
      return String(v);
    }
    function colorForValue(val) {
      // deterministische Pastellfarbe aus String-Hash (HSL)
      const h = hashString(val) % 360;
      const s = 65; // %
      const l = 88; // %
      return `hsl(${h} ${s}% ${l}%)`;
    }
    function hashString(s) {
      let h = 2166136261 >>> 0; // FNV-1a
      for (let i = 0; i < s.length; i++) {
        h ^= s.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    // Exec helper
    function execRaw(sql) { return db.exec(sql); }

    // Escape HTML
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Page size change
    $('#pageSize').addEventListener('change', () => {
      if (currentTable) loadPage();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (!$('#btnRun').disabled) $('#btnRun').click();
      }
    });
  </script>
</body>
</html>
